<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

    <script src="/jquery.js"></script>
    <script></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script type="text/javascript" src="/fabric.min.js"></script>
    <script type="text/javascript" src="/pagination.min.js"></script>
    <script type="text/javascript" src="/algo.visual.toolbox.js"></script>
    <script type="text/javascript" src="/rx.all.min.js"></script>
    <script type="text/javascript" src="/rx.all.min.js"></script>

    <script type="text/javascript" src="/jquery.lettering.js"></script>
    <script type="text/javascript" src="/jquery.fittext.js"></script>
    <script type="text/javascript" src="/rulez.min.js"></script>
    <script type="text/javascript" src="/mediaelement.js"></script>
    <script type="text/javascript" src="/mediaelement-plugins/speed/speed.min.js"></script>
    <script type="text/javascript" src="/mediaelement-plugins/loop/loop.min.js"></script>
    <!-- <script type="text/javascript" src="/treant.js"></script> -->
    <link rel="stylesheet" href="/animate.css">
    <link rel="stylesheet" href="/treant.css">
    <script src="/vendor/raphael.js"></script>

    <!-- <script src="../../vendor/jquery.min.js"></script> -->
    <script src="../../vendor/jquery.easing.js"></script>

    <script type="text/javascript" src="/jquery.textillate.js"></script>
    <!--    <script src="/typed.min.js"></script>-->

    <script type="text/javascript" src="/diff-match-patch.js"></script>
    <script type="text/javascript" src="/data-structures.js"></script>
    <!--    <script src="/underscore.min.js"></script>-->
    <link href="/select2.min.css" rel="stylesheet"/>
    <link href="/pagination.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/mediaelement@latest/build/mediaelementplayer.min.css" rel="stylesheet"/>
    <link href="/index.css" rel="stylesheet"/>

    <script src="/select2.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/velocity-animate@2.0/velocity.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/velocity-animate@2.0/velocity.ui.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG">
    </script>
    <script src="/ace/src-noconflict/ace.js" type="text/javascript" charSet="utf-8"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"/>
    <link rel="stylesheet" type="text/css" href="/mediaelement-plugins/speed/speed.min.css"/>
    <link rel="stylesheet" type="text/css" href="/mediaelement-plugins/loop/loop.min.css"/>

    <script type="text/javascript">
      Array.prototype.max = function () {
        return Math.max.apply(null, this);
      };
    </script>
    <style>
    .btn {
        cursor: pointer;
    }

    .Comment {
      border-left: 1px solid black;
      padding-left: 4px;
    }
    .btn:hover {
      background-color: cyan;
    }

    .highlight, .highlighted-selection {
      background-color: yellow;
    }

    .srt-line.selected {
      background-color: cyan;
    }
    </style>

    <script src="/play.js"></script>
    <script src="/lodash.js"></script>
    <link rel="stylesheet" href="/play.css">
    <link rel="stylesheet" href="/fontawesome-all.css">

    <script>
      async function extractMP3(url, request) {
        let resp = await fetch(url, {
          method: "POST",
          body: JSON.stringify(request),
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json",
          }
        });
        console.log(resp)
      }

      function chunkifySentence(text, max_chars) {
        let words = text.split(" ")
        let res = []
        let current = ""
        for(let i=0; i < words.length; i++) {
          let w = words[i]
          if(current.length + w.length >= max_chars) {
            res.push(current)
            current = w+" "
          } else {
            current += (w + " ")
          }
        }
        res.push(current)
        return res
      }

      function exportSelection(file, button) {
        console.log(file)
        $(button).parent('.srt-file').find(".srt-line").each(async (i, e) => {
          if ($(e).find("input:checked").length) {
            let folderName = $('#folderName').val().trim() || window.searchText
            let fl = $(e).data("file")

            fl = window.searchResult.find(it => it.path._str === fl.path._str)

            let lines = $(e).find(".line").map((i,e) => $(e).data()).toArray()
                            .map(it => it.index).map(idx => fl.data.find(it => it.index === idx))
            console.log(fl, lines)
            let url = 'http://localhost:5000/extract_word_from_subtitle'
            let request = {
              srt_path: file,
              start: lines[0].start.ordinal,
              end: lines[lines.length-1].end.ordinal,
              word: folderName,
              text: lines.map(it => it.text).join(" ")
            };
            await extractMP3(url, request);
          }
        })
      }

      function getTimes(el, fl) {
        let lines = $(el).find(".line").map((i,e) => $(e).data()).toArray()
          .map(it => it.index).map(idx => fl.data.find(it => it.index === idx))

        return {
          start: lines[0].start.ordinal, end: lines[lines.length-1].end.ordinal
        }
      }

      function highlightedText(text) {
        let hText = text
        try {
          let match = text.match(new RegExp(window.searchText, "i"))
          let index = match.index
          hText = text.substring(0, index) + "<span class='highlight'>" + text.substring(index, index + match[0].length) + "</span>" + text.substring(index + match[0].length);
        } catch (e) {
          console.log(e)
        }
        return hText;
      }

      function playSelectedText(e) {
        let selTxt = getSelectionText() || ''

        function playChunk(_txt) {
          return new Promise(function(resolve, reject) {
            let a = new Audio()
            a.src = "http://localhost:5000/tts-proxy?q=" + _txt
            a.preload = "auto";
            a.onerror = reject;                      // on error, reject
            a.onended = resolve;                     // when done, resolve
            a.playbackRate = 1.2
            a.play()
          });
        }

        let play = () => {
          let txt = selTxt.length > 1 ? selTxt : $(e.target).parent().data('text')

          let chunks = chunkifySentence(txt)

          let first = chunks.shift()
          let promise = playChunk(first)

          promise.then(x => restoreBgMusic())
        }
        dampenBgMusic().then(x => play())
      }

      function render(list, search) {
        window.searchResult = list;
        window.searchText = search;

        let $result = $('#result');
        $result.html('')

        function htmlForSrtLine(line, file, url) {
          let text = _.trim(line.text, "-:_");
          let hText = highlightedText(text);

          return $(`<div class="srt-line" data-index="${line.index}" data-file="${file.path._str}">
                                    <input type="checkbox"/>
                                    <span class="add-prev-btn btn"> + </span>
                                    <span class="remove-next-btn btn"> - </span>
                                    <span class="line main-line" data-index="${line.index}"> ${hText} </span>
                                    <span class="remove-prev-btn btn"> - </span>
                                    <span class="add-next-btn btn"> + </span>
                                    <img src="/img/icons/play_icon.png" alt="" style="width: 20px;height: 20px;cursor: pointer;" class="play-btn" data-url="${url}">
                                 </div>`).data({line: line, file: file})
        }

        $result.append('<br><br>')


        list.filter(it => it.text).forEach(item => {
          let $line = $(`<div class="normal-line"></div>`)

          chunkifySentence(item.text, 190).forEach(chunk => {
            let div = $(`
    <div class="line-part"> ${highlightedText(chunk)} <img src="/img/icons/play_icon.png"
        alt="" style="width: 20px;height: 20px;cursor: pointer;" class="play-btn">
    </div>`);
            div.data({text: chunk})
            $line.append(div)
          })

          $result.append($line).append('<br>')
        })

        $result.append("<hr>")

        list.filter(it => it.subs).forEach(item => {
          let file = item.subs
          let parts = file.path._str.split("/")
          let fileName = parts[parts.length - 1]
          let $file = $(`<div class="srt-file">
                            <h4> ${fileName} </h4> <button onclick="exportSelection('${file.path._str}', this)"> Export </button>
                        </div>`)
          let matchingLines = file.data.filter(it => it.text.toLowerCase().match(search))

          matchingLines.forEach(line => {
            $file.append(htmlForSrtLine(line, file, item.url));
          })

          $result.append($file)
        })

        $('.add-prev-btn').click(e => {
          let plusBtn = $(e.target);
          let dt = plusBtn.parent().data()

          let lines = plusBtn.parent().find(".line").toArray()
          let firstLine = $(lines[0])

          let nextLine = firstLine.data('index')
          if(nextLine < 2) return

          let newLn = dt.file.data[nextLine-2]
          let $newLine = $(`<span class="line" data-index="${newLn.index}"> ${newLn.text}</span>`);
          $newLine.insertBefore(firstLine)
        })
        $('.add-next-btn').click(e => {
          let plusBtn = $(e.target);
          let dt = plusBtn.parent().data()
          let lines = plusBtn.parent().find(".line").toArray()
          let lastLine = $(lines[lines.length-1])

          let prevLine = lastLine.data('index')
          if(prevLine === dt.file.data.length) return

          let newLn = dt.file.data[prevLine]
          let $newLine = $(`<span class="line" data-index="${newLn.index}"> ${newLn.text}</span>`);
          $newLine.insertAfter(lastLine)
        })

        $('.remove-prev-btn').click(e => {
          let btn = $(e.target);
          let dt = btn.parent().data()
          let prevLine = btn.prev('.line')
          if(prevLine.hasClass("main-line")) return

          prevLine.remove()
        })

        $('.remove-next-btn').click(e => {
          let btn = $(e.target);
          let dt = btn.parent().data()
          let nextLine = btn.next('.line')
          if(nextLine.hasClass("main-line")) return

          nextLine.remove()
        })

        $(".srt-line .play-btn").click(e => {
          if($(e.target).hasClass('disabled')) return

          $('.srt-line').removeClass('selected')
          $(e.target).parents('.srt-line').addClass('selected')

           let url = $(e.target).data("url")
           let dt = $(e.target).parent().data()

          let times = getTimes($(e.target).parent(), dt.file)

          let btn = $(e.target)
          $(btn).addClass('disabled')

          let play = ()=> {
            let st = times.start;
             console.log(1)
            let a = new Audio()
            a.src = "http://localhost:5000/mp3_slice?srt_path="+ dt.file.path._str.replace(".srt", ".mp3") + "&start=" + st + "&end=" + times.end
            a.play()
            a.currentTime = st
            a.onended = e => {
              restoreBgMusic()
              btn.removeClass('disabled')
            }

            a.onerror = e => {
               console.log("err", e)
               restoreBgMusic()
            }
          }

          dampenBgMusic().then(x => play())

           // $( "#audioPlayerPopup" ).dialog('open')
           // $('#audioPlayerPopup').css({width: '100%'})
        })

        $(".normal-line .play-btn").click(e => {
          playSelectedText(e);
        })
      } // end render

      function getSelectionText() {
        let text = "";
        if (window.getSelection) {
          text = window.getSelection().toString();
        } else if (document.selection && document.selection.type != "Control") {
          text = document.selection.createRange().text;
        }
        return text;
      }

      function fetchSRTs(el) {
        let txt = $("#searchText").val().toLowerCase()
        fetch("http://localhost:5000/find?text=" + txt)
          .then(it => it.json())
          .then(it => render(it, txt))
      }

      function iframeLoaded(it) {
        console.log("Loaded", it)
      }

    </script>
    <style>

    </style>
</head>

<body>
<div style="float: left; width: 50%;">
    <div id="audioPlayerPopup" style="width: 100% !important;">
        <div id="ytPlayerDiv"></div>
    </div>
    <input type="text" id="searchText" placeholder="Search text"
           onchange="fetchSRTs(this)"
    >

    <input type="text" id="folderName" placeholder="Folder name">

    <div id="extra-content">
    </div>

    <div id="wikiResult" style="max-height: 300px; overflow: scroll">
        <iframe id="wikiFrame" src="https://sv.wiktionary.org/wiki/upplevelse#Substantiv" width="100%" height="100%" onload="iframeLoaded()">
            <script>
              function getSelectionText() {
                let text = "";
                if (window.getSelection) {
                  text = window.getSelection().toString();
                } else if (document.selection && document.selection.type !== "Control") {
                  text = document.selection.createRange().text;
                }
                return text;
              }

              function receiver(event) {
                if (event.origin === 'https://sv.wiktionary.org/') {
                  if (event.data === 'getSelection') {
                    let text = getSelectionText();
                    event.source.postMessage(text, event.origin);
                  }
                  else {
                    alert(event.data);
                  }
                }
              }
              window.addEventListener('message', receiver, false);
            </script>
        </iframe>
    </div>
    <div id="result">
    </div>
</div>
<div style="float: right; left: 51%; width: 49%; position: fixed;">
    <div>
        <textarea id="enteredWords" onchange="populateWords()"></textarea>
        <input id="bgMusicInput" type="file" accept="audio/mpeg" onchange="playBgMusic()">
    </div>
    <div style="">
        <audio id="bgMusicAudio" controls="controls" ></audio>
        <img src="/img/icons/play_icon.png" alt="" style="width: 20px;height: 20px;cursor: pointer;" class="play-btn" onclick="playSelectedText()">
    </div>

    <div id="wordlist" style="height: 600px; overflow: scroll; margin-top: 1em;">

    </div>
</div>
<script>

function playBgMusic() {
    bgMusicAudio.src = URL.createObjectURL(document.getElementById('bgMusicInput').files[0])
}

function dampenBgMusic() {
  let promise = new Promise((res, rej) => {
    let min = 0.05

    let vol = bgMusicAudio.volume;
    let interval = 200; // 200ms interval

    let fadeout = setInterval(
      function() {
        // Reduce volume by 0.05 as long as it is above 0
        // This works as long as you start with a multiple of 0.05!
        if (vol > min) {
          vol -= 0.05;
          bgMusicAudio.volume = vol;
        }
        else {
          // Stop the setInterval when 0 is reached
          clearInterval(fadeout);
          res(1)
        }
      }, interval);
  })
  return promise
}

function restoreBgMusic() {
  return new Promise((res, rej) => {
    let max = 0.7
    let vol = bgMusicAudio.volume;
    let interval = 200; // 200ms interval

    let fadein = setInterval(
      function () {
        // Reduce volume by 0.05 as long as it is above 0
        // This works as long as you start with a multiple of 0.05!
        if (vol < max) {
          vol += 0.05;
          if (vol > max) {
            vol = max
          }
          bgMusicAudio.volume = vol;
        } else {
          // Stop the setInterval when 0 is reached
          clearInterval(fadein);
          res(1)
        }
      }, interval);
  })
}

function whenWikiLinkClicked(e) {
  e.preventDefault()
  e.stopPropagation()
  if (e.target.href.indexOf("/wiki/") > 0) {
    window.location.hash = e.target.href.split("/wiki/")[1]
    populateWiki()
  }
}

window.onhashchange = e => {
  populateWiki()
}
function populateWiki() {
  let w = window.location.hash
  w = w.substring(1)
  fetch("http://localhost:5000/proxy?url=https://sv.wiktionary.org/wiki/"+w)
    .then(it => it.text())
    .then(it => {
      let $result = $('#wikiResult');
      $result.html(it)
      $(".noprint").remove()
      $(".mw-jump-link").remove()
      $(".mw-headline").parent().remove()
      $("#toc").remove()
      $result.find("a").each((i,e) => {
        $(e).click(linkClicked => {
          whenWikiLinkClicked(linkClicked);
        })
      }) //find end
    })
}

function populateWords() {
  let words = enteredWords.value
  words = words.split(" ").map(x => `<span>${x}</span>`).join(" ")
  words = words.replaceAll("\n", "<br>").replaceAll("-", "+")

  let $wordlist = $("#wordlist");
  $wordlist.html(words)

  $wordlist.dblclick(e => {
    $('#searchText').val(getSelectionText())
    fetchSRTs()
    window.location.hash = getSelectionText()
    populateWiki()
    $("*").removeClass("highlighted-selection")
    $(getSelectionParentElement()).addClass("highlighted-selection")
  })

  $("img[alt='User avatar']").remove()
  $("img[alt='Subreddit Icon']").parent().parent().parent().remove()
  $("button").remove()
  $("svg").remove()
  $("*[data-click-id=\"body\"]").remove()
  $("span:contains('ConcentrateSlow4119')").remove()
  $("*[data-testid=\"comment_author_link\"]").parent().parent().parent().parent().remove()

  let commCounter = 0;
  $("span:contains('level ')").each((i, e) => {
    let $comment = $('<div> Comment </div>');
    if($(e).text().trim() === 'level 1') {
      $comment.html(`#${++commCounter} Comment`)
    }
    let $el = $comment.addClass('accordion')
    $el.insertBefore($(e))
  })

  renderAccordions()
}
</script>

<script>

  $( "#audioPlayerPopup" ).dialog({
    modal: true,
    width: 390,
    height: 400,
    autoOpen: false,
    open: function(){
      $('.ui-widget-overlay').bind('click',function(){
        $('#audioPlayerPopup').dialog('close');
      })
    }
  });

  function getRandomInt(max) {
    return Math.floor(Math.random() * max);
  }

  function renderAccordions() {
    console.log('Rendering accordions')

    let isAccordion = it => Array.from(it.classList.values()).indexOf('accordion') >= 0

    function fixAccordionPanel(accordionEl) {
      let el = accordionEl.nextElementSibling
      let siblings = []
      while(el) {
        if(isAccordion(el)) break

        siblings.push(el)
        el = el.nextElementSibling
      }

      if(siblings.length > 1) {
        let newEl = document.createElement('div')
        newEl.classList.add('autocreated-panel')
        siblings.forEach(it => newEl.appendChild(it))

        accordionEl.insertAdjacentElement('afterend', newEl)
      }
    }

    let acc = document.getElementsByClassName("accordion");
    let i;

    for (i = 0; i < acc.length; i++) {
      acc[i].classList.add(i % 2 === 0 ? 'even' : 'odd')

      if(acc[i].dataset.accordion_rendered === "true") continue;

      fixAccordionPanel(acc[i])
      acc[i].addEventListener("click", function() {
        /* Toggle between adding and removing the "active" class,
        to highlight the button that controls the panel */
        this.classList.toggle("active");

        /* Toggle between hiding and showing the active panel */
        let panel = this.nextElementSibling;
        if (panel.style.display === "block") {
          panel.style.display = "none";
        } else {
          panel.style.display = "block";
        }
      });
    }
  }

  function getSelectionParentElement() {
    let parentEl = null, sel;
    if (window.getSelection) {
      sel = window.getSelection();
      if (sel.rangeCount) {
        parentEl = sel.getRangeAt(0).commonAncestorContainer;
        if (parentEl.nodeType != 1) {
          parentEl = parentEl.parentNode;
        }
      }
    } else if ( (sel = document.selection) && sel.type != "Control") {
      parentEl = sel.createRange().parentElement();
    }
    return parentEl;
  }
</script>


</body>
<style>
  *:after {
    content: none !important;
  }
</style>
</html>
