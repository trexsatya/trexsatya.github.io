<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

    <script src="/jquery.js"></script>
    <script></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script type="text/javascript" src="/fabric.min.js"></script>
    <script type="text/javascript" src="/pagination.min.js"></script>
    <script type="text/javascript" src="/algo.visual.toolbox.js"></script>
    <script type="text/javascript" src="/rx.all.min.js"></script>
    <script type="text/javascript" src="/rx.all.min.js"></script>

    <script type="text/javascript" src="/jquery.lettering.js"></script>
    <script type="text/javascript" src="/jquery.fittext.js"></script>
    <script type="text/javascript" src="/rulez.min.js"></script>
    <script type="text/javascript" src="/mediaelement.js"></script>
    <script type="text/javascript" src="/mediaelement-plugins/speed/speed.min.js"></script>
    <script type="text/javascript" src="/mediaelement-plugins/speed/speed-i18n.js"></script>
    <!-- <script type="text/javascript" src="/treant.js"></script> -->
    <link rel="stylesheet" href="/animate.css">
    <link rel="stylesheet" href="/treant.css">
    <script src="/vendor/raphael.js"></script>

    <!-- <script src="../../vendor/jquery.min.js"></script> -->
    <script src="../../vendor/jquery.easing.js"></script>

    <script type="text/javascript" src="/jquery.textillate.js"></script>
    <!--    <script src="/typed.min.js"></script>-->

    <script type="text/javascript" src="/diff-match-patch.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <link href="/select2.min.css" rel="stylesheet"/>
    <link href="/pagination.css" rel="stylesheet"/>

    <script src="/select2.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/velocity-animate@2.0/velocity.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/velocity-animate@2.0/velocity.ui.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG">
    </script>
    <script src="/ace/src-noconflict/ace.js" type="text/javascript" charSet="utf-8"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript">
        Array.prototype.max = function () {
            return Math.max.apply(null, this);
        };
    </script>
    <style>

    </style>

    <script src="/play.js"></script>
    <!--    <script src="/play2.js"></script>-->
    <link rel="stylesheet" href="/play.css">
    <link rel="stylesheet" href="/fontawesome-all.css">

    <script>
        async function loadSubtitle(file) {
            let text = await file.text();
            // console.log(text);
            window.subtitles = JSON.parse(text)
        }

        function togglePlay(el) {
            if (!el) el = $('#playBtn')[0]

            if ($(el).text() === 'Play') {
                player.play()
                $(el).html("Pause").removeClass('play-btn').addClass('pause-btn')
            } else {
                player.pause()
                $(el).html("Play").removeClass('pause-btn').addClass('play-btn')
            }
        }
    </script>
    <style>
        #playBtn {
            border-radius: 50%;
            height: 5em;
            width: 5em;
            cursor: pointer;
        }

        .play-btn {
            background: blue;
            color: white;
        }

        .pause-btn {
            background: red;
            color: white;
        }

        body {
            touch-action: manipulation;
        }
    </style>
</head>

<body>

<div>
    <iframe width="0" height="0"
            src="https://www.youtube.com/embed/tgbNymZ7vqY?autoplay=1&mute=1&loop=1">
    </iframe>

<!--    Subtitles: <input type="file" onChange="loadSubtitle(this.files[0])" title="Subtitles" accept="application/JSON">-->
<!--    <br>-->
<!--    <br>-->
<!--    Audio: <input id="video-file" type="file" title="Video"/>-->

    <select id="mp3Choice">
        <option value="">-</option>
    </select>

    <audio id="video" src="" width="700" height="500"></audio>
</div>
<br/>
<div style="color: grey;">
    Current: <span id="currentNumber"></span> <span id="currentTime" style="padding-left: 1em;"></span> <span id="currentSpeed" style="padding-left: 1em;"></span>
</div>

<div id="subtitle-container" style="min-height: 150px;">
    <br>
    <br>
    <div id="sv-sub" style="font-weight: bold; font-size: large; color: blue"></div>
    <br>
    <br>
    <div id="en-sub" style=""></div>
</div>
<div style="margin-top: 8em; width: 100%;">

    <div class="controlgroup">
        <label for="speed-1">0.5</label>
        <input type="radio" name="speedOption" id="speed-1" data-speed="0.5">
        <label for="speed-2">0.7</label>
        <input type="radio" name="speedOption" id="speed-2"  data-speed="0.7">
        <label for="speed-3">0.8</label>
        <input type="radio" name="speedOption" id="speed-3" data-speed="0.8">
        <label for="speed-4">1.0</label>
        <input type="radio" name="speedOption" id="speed-4" checked data-speed="1.0">
    </div>
    <div style="text-align: center; margin-top: 2em;">
        <div id="pagination"></div>
        <br>
        <button id="rewindBtn" style="font-weight: bolder;font-size: larger; margin-right: 3em;width: 5em;height: 9em;" onclick="rewind()"> < </button>
        <button onclick="togglePlay(this)" id="playBtn" class="play-btn" disabled>Play</button>
    </div>
</div>
<div id="message" style="display: none"></div>

<script>
    function toSeconds(str) {
        let splits = str.split(":")
        let hour = 0, mins = 0, secs = 0
        if (splits.length === 2) {
            mins = splits[0]
            secs = splits[1]
        }
        if (splits.length === 3) {
            hour = splits[0]
            mins = splits[1]
            secs = splits[2]
        }
        return parseInt(hour) * 3600 + parseInt(mins) * 60 + parseInt(secs)
    }

    function fromSeconds(number) {
        let _pad = x => x.length < 2 ? '0' + x : x;
        let hrs = Math.floor(number / 3600) + ''
        let mins = Math.floor((number % 3600) / 60) + ''
        let secs = Math.floor((number % 3600) % 60) + ''


        return `${_pad(hrs)}:${_pad(mins)}:${_pad(secs)}`
    }

    let URL = window.URL || window.webkitURL
    let displayMessage = function (message, isError) {
        let element = document.querySelector('#message')
        element.innerHTML = message
        element.className = isError ? 'error' : 'info'
    }

    let player = new MediaElement(document.querySelector('audio'), {
        defaultSpeed: 1.0,
        features: ['speed'],
        success: function(mediaElement, originalNode) {
            console.log('Media element', mediaElement, originalNode)
        }
    });

    window.player = player
    window.marginStartSubtitle = - 0.1
    window.marginEndSubtitle = 1

    const isIOS = () => {
        const iosQuirkPresent = function () {
            const audio = new Audio();

            audio.volume = 0.5;
            return audio.volume === 1;   // volume cannot be changed from "1" on iOS 12 and below
        };

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAppleDevice = navigator.userAgent.includes('Macintosh');
        const isTouchScreen = navigator.maxTouchPoints >= 1;   // true for iOS 13 (and hopefully beyond)

        return isIOS || (isAppleDevice && (isTouchScreen || iosQuirkPresent()));
    };

    if(isIOS()) {
        window.marginStartSubtitle = -1
        window.marginEndSubtitle = 0
    }

    window.marginStartSubtitle = 0
    window.marginEndSubtitle = 0

    function pauseVideo() {
        window.player.pause()
        $('#playBtn').html('Play')
    }
    let currentVideoTime = () => {
        return parseFloat(parseFloat(player.getCurrentTime() + '').toFixed(2))
    }
    let clearSubtitles = () => {
        $('#sv-sub').html('')
        $('#en-sub').html('')
    }

    let populateSubtitles = (currentSub) => {
        $('#currentNumber').html(currentSub.number)
        $('#currentTime').html(fromSeconds(currentVideoTime()) + ' / [' + currentSub.ts_o + '-' + currentSub.te_o + ']')
        $('#currentSpeed').html(player.getPlaybackRate() + ' / ' + currentSub.speed)

        $('#sv-sub').html('')
        currentSub.sv.split(" ").map(it => it.trim()).filter(it => it.length > 0).forEach(word => {
            let sanitizedWord = word
            if(['-', '–', '!', '.', ','].some(it => sanitizedWord.startsWith(it))) {
                sanitizedWord = sanitizedWord.substr(1)
            }

            if(['-', '–', '!', '?', '.', ','].some(it => sanitizedWord.endsWith(it))) {
                sanitizedWord = sanitizedWord.substr(0, sanitizedWord.length - 1)
            }

            let wordLink = $(`<span> <a href="https://sv.wiktionary.org/wiki/${encodeURIComponent(sanitizedWord)}" target="_blank">${word}</a></span>`);
            wordLink.click(e => {
                pauseVideo()
            })
            $('#sv-sub').append(wordLink)
        })

        $('#en-sub').html(currentSub.en)
    }
    let prepareSubs = (pageNumber, allSubs) => {
        pageNumber = parseInt(pageNumber)

        //Reset
        let subs = [allSubs[pageNumber - 1]].flatMap(sub => [
            // {...sub, speed: 0.6}
            // , {...sub, speed: 0.8}
             {...sub, speed: 1.0}
        ])

        let currentSub = subs.shift()

        player.setCurrentTime(Math.max(currentSub.ts + window.marginStartSubtitle, 0))

        if(!window.rewindData)
        player.setPlaybackRate(currentSub.speed)

        player.play()

        window.subs = subs
        window.currentSub = currentSub
        window.pageNumber = pageNumber

        $('#playBtn').html('Pause')
    }

    let mp3s = [ 'https://storage.googleapis.com/cupitor-220103.appspot.com/swedish_media/First%20patient%20receives%20milestone%20stem%20cell-based%20transplant%20for%20Parkinson%E2%80%99s%20Disease.mp3',
    'https://storage.googleapis.com/cupitor-220103.appspot.com/swedish_media/Stephanie%20om%20studentlivet%20i%20Halmstad.mp3']

    $('#mp3Choice').html('').append($(`<option>-</option>`).attr('value', ''))

    mp3s.forEach(it => {
          let parts = it.split("/")
          let $opt = $(`<option>${decodeURI(parts[parts.length-1])}</option>`).attr('value', it)
          $('#mp3Choice').append($opt)
    })

    function srtToJson(text, lang) {
      let parseSrtItem = (x, lang) => {
        let [id, times, ...rest] =  x.split("\n")
        let [ts, te] = times.split(" --> ")
        let item = {ts: ts, te: te, id: id}
        item[lang] = rest.join("\n")
        return item
      }
      return text.trim().split("\n\n").map(it => parseSrtItem(it, lang))
    }


    function srtNamesFromUrl(url) {
      url = url.replace(".mp3", ".srt")
      let splits = url.split("/")
      let nm =  splits[splits.length-1]

      return {sv: nm, en: nm.replace(".srt", "_EN.srt")}
    }

    function srtUrl(srtNm) {
      return `https://raw.githubusercontent.com/trexsatya/trexsatya.github.io/gh-pages/db/srts/${srtNm}`
    }

    $('#mp3Choice').change(async e => {
      //Load subtitle
      let mp3Url = $('#mp3Choice').val()
      if(mp3Url.indexOf('https://') < 0) return

      let srtNames = srtNamesFromUrl(mp3Url)

      let svSrt = await fetch(srtUrl(srtNames.sv), {})
      let sv = await svSrt.text()

      let enSrt = await fetch(srtUrl(srtNames.en), {})
      let en = await enSrt.text()

      sv = srtToJson(sv, 'sv')
      en = srtToJson(en, 'en')

      let combined = sv.map(svItem => {
        let enItem = en.find(eni => eni.id === svItem.id)
        return {...svItem, ...enItem}
      })
      // console.log(sv)
      // console.log(en)
      console.log(combined)

      window.subtitles = combined

      player.setSrc(mp3Url)

      playSelectedFile()
    })

    let playSelectedFile = function (event) {
        // let file = this.files[0]
        // let type = file.type
        //
        // let canPlay = player.canPlayType(type)
        // if (canPlay === '') canPlay = 'no'
        // let message = 'Can play type "' + type + '": ' + canPlay
        // let isError = canPlay === 'no'
        // displayMessage(message, isError)
        //
        // if (isError) {
        //     return
        // }
        //
        // player.setSrc(URL.createObjectURL(file))

        let strategy = "Normal-Slow"

        let originalSubs = window.subtitles.map(it => ({...it}))

        window.subtitles = originalSubs
        originalSubs.forEach(it => {
            it['ts_o'] = it['ts']
            it['ts'] = toSeconds(it['ts'])
        })

        originalSubs = _.sortBy(originalSubs, it => it.ts)

        for (let i = 0; i < originalSubs.length - 1; i++) {
            originalSubs[i]['te_o'] = originalSubs[i + 1]['ts_o']
            originalSubs[i]['te'] = originalSubs[i + 1]['ts'] - 0.009
            originalSubs[i]['number'] = i + 1
        }

        $('#pagination').pagination({
            dataSource: range(1, originalSubs.length + 1),
            pageSize: 1,
            // showPrevious: false,
            // showNext: false,
            showGoInput: true,
            showGoButton: true,
            formatGoInput: 'go to <%= input %> st/rd/th',
            callback: function (data, pagination) {
                console.log(data)
                window.rewindData = null
                prepareSubs(data, originalSubs)
            }
        })

        $('#playBtn').attr('disabled', false)
        prepareSubs(1, originalSubs)

        const ontimeupdate = e => {
            // console.log(currentSub, player.currentTime)
            let ct = player.getCurrentTime()

            let currentSub = window.currentSub
            let subs = window.subs

            if(window.rewindData) {
                if(ct >= window.rewindData.from) {
                    window.rewindData = null
                    console.log("Resetting speed", ct)
                    player.setPlaybackRate(currentSub.speed)
                } else {
                    // return
                }
            }

            populateSubtitles(currentSub)
            player.setPlaybackRate($('.controlgroup input:checked').data('speed'))

            if (!window.rewindData && ct >= currentSub.te + window.marginEndSubtitle) {
                // Go to next subtitle
                // player.pause()
                if (subs.length === 0) {
                    $('#pagination').pagination('go', window.pageNumber + 1)
                } else {
                    currentSub = subs.shift()
                    window.currentSub = currentSub
                    player.setCurrentTime(Math.max(currentSub.ts + window.marginStartSubtitle, 0))

                    if(currentSub.speed < 1) {
                        player.setPlaybackRate($('.controlgroup input:checked').data('speed'))
                    } else if(!window.rewindData){
                        player.setPlaybackRate(currentSub.speed)
                    }

                    console.log(currentSub)
                    clearSubtitles()
                }
            }
        }
        player.addEventListener('timeupdate', ontimeupdate)

        console.log(originalSubs.map(it => `${it.number} ${it.ts_o}-${it.te_o} (${it.ts}-${it.te} )-> ${it.sv}`).join("\n"))
    }

    let inputNode = document.querySelector('#video-file')
    if(inputNode)
        inputNode.addEventListener('change', playSelectedFile, false)

    function rewind() {
        window.rewindData = window.rewindData || {
            from: player.getCurrentTime(),
        }

        console.log("Should come back to", window.rewindData.from)
        player.setPlaybackRate($('.controlgroup input:checked').data('speed'))
        player.setCurrentTime(player.currentTime - 3)
    }

    $('.controlgroup').controlgroup()

    document.onkeyup = e => {
        if(e.which === 32) { //Space
            togglePlay()
        }
    }
</script>
</body>

</html>
