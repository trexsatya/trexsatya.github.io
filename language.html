<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

    <script src="/jquery.js"></script>
    <script></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script type="text/javascript" src="/fabric.min.js"></script>
    <script type="text/javascript" src="/pagination.min.js"></script>
    <script type="text/javascript" src="/algo.visual.toolbox.js"></script>
    <script type="text/javascript" src="/rx.all.min.js"></script>
    <script type="text/javascript" src="/bootstrap.min.js"></script>

    <script type="text/javascript" src="/jquery.lettering.js"></script>
    <script type="text/javascript" src="/jquery.fittext.js"></script>
    <script type="text/javascript" src="/rulez.min.js"></script>
    <script type="text/javascript" src="/mediaelement.js"></script>
    <script type="text/javascript" src="/mediaelement-plugins/speed/speed.min.js"></script>
    <script type="text/javascript" src="/mediaelement-plugins/speed/speed-i18n.js"></script>
    <!-- <script type="text/javascript" src="/treant.js"></script> -->
    <link rel="stylesheet" href="/animate.css">
    <link rel="stylesheet" href="/treant.css">
    <script src="/vendor/raphael.js"></script>

    <!-- <script src="../../vendor/jquery.min.js"></script> -->
    <script src="../../vendor/jquery.easing.js"></script>

    <script type="text/javascript" src="/jquery.textillate.js"></script>
    <!--    <script src="/typed.min.js"></script>-->

    <script type="text/javascript" src="/diff-match-patch.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <link href="/select2.min.css" rel="stylesheet"/>
    <link href="/pagination.css" rel="stylesheet"/>
    <link href="/bootstrap.min.css" rel="stylesheet"/>
    <link href="/bootstrap-grid.min.css" rel="stylesheet"/>

    <script src="/select2.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/velocity-animate@2.0/velocity.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/velocity-animate@2.0/velocity.ui.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG">
    </script>
    <script src="/ace/src-noconflict/ace.js" type="text/javascript" charSet="utf-8"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript">
      Array.prototype.max = function () {
        return Math.max.apply(null, this);
      };
    </script>
    <style>

    </style>

    <script src="/play.js"></script>
    <!--    <script src="/play2.js"></script>-->
    <link rel="stylesheet" href="/play.css">
    <link rel="stylesheet" href="/fontawesome-all.css">

    <script>
      function togglePlay(el) {
        if (window.playingVideo) {
          if (ytPlayer.getPlayerState() === 2) {
            ytPlayer.playVideo()
          } else if (ytPlayer.getPlayerState() === 1) {
            ytPlayer.pauseVideo()
          }
        } else {
          if (player.paused) {
            player.play()
          } else {
            player.pause()
          }
        }
      }
    </script>
    <style>
      #playBtn {
        border-radius: 50%;
        height: 5em;
        width: 5em;
        cursor: pointer;
      }

      .play-btn {
        background: blue;
        color: white;
      }

      .pause-btn {
        background: red;
        color: white;
      }

      body {
        touch-action: manipulation;
      }
    </style>
</head>

<body style="padding: 0.5em;">

<div>

    <!--    Subtitles: <input type="file" onChange="loadSubtitle(this.files[0])" title="Subtitles" accept="application/JSON">-->
    <!--    <br>-->
    <!--    <br>-->
    <!--    Audio: <input id="video-file" type="file" title="Video"/>-->

    <label for="mp3Choice">Select Media:</label>
    <select id="mp3Choice" style="width: 100%">
        <option value="">-</option>
    </select>
    <div style="padding-top: 0.5em; padding-bottom: 0.5em;">
        Search Text: <input id="searchInput" onchange="searchText()">
    </div>
    <span class=""><a href="" target="_blank" id="youtube-link" style="display: none;">Search on Youtube</a></span>
    <audio id="video" src="" width="700" height="500"></audio>

    <div>
        <div id="player" style="display:none; margin-top: 2em;"></div>
        <div style="min-height: 150px;float: right;">
            <div id="subtitle-container">
                <br>
                <br>
                <div id="sv-sub" style="font-weight: bold; font-size: large; color: blue"></div>
                <br>
                <br>
                <div id="en-sub" style="display: none;"></div>
                <div style="margin-top: 2em;">
                    <span class="btn btn-secondary" id="toggleEnSubBtn" onclick="$('#en-sub').toggle()"> Toggle English Subtitles </span>
                </div>
            </div>
            <div style="margin-top: 8em; width: 30%; position: absolute; bottom: 4em; right: 4em;" id="controls">

                <div class="">
                    <div>
                        <div class="controlgroup" id="speed-control">
                            <label for="speed-1">0.5</label>
                            <input type="radio" name="speedOption" id="speed-1" data-speed="0.5">
                            <label for="speed-2">0.7</label>
                            <input type="radio" name="speedOption" id="speed-2" data-speed="0.7">
                            <label for="speed-3">0.8</label>
                            <input type="radio" name="speedOption" id="speed-3" data-speed="0.8">
                            <label for="speed-4">1.0</label>
                            <input type="radio" name="speedOption" id="speed-4" checked data-speed="1.0">
                        </div>
                        <label for="speed-control">x Speed</label>
                    </div>
                    <br>
                    <div class="form-check form-switch" style="display: none;">
                        <label class="form-check-label" for="loopSwitch">Loop </label>
                        <input class="form-check-input" type="checkbox" role="switch" id="loopSwitch">
                    </div>

                </div>
                <div style="text-align: center; margin-top: 2em;">
                    <div id="pagination"></div>
                    <br>
                    <button id="rewindBtn"
                            style="font-weight: bolder;font-size: larger; margin-right: 3em;width: 3em;height: 2em;"
                            onclick="rewind()"> <
                    </button>
                    <button onclick="togglePlay(this)" id="playBtn" class="play-btn" disabled>Play</button>
                </div>
            </div>
        </div>
    </div>
</div>
<br/>
<div style="color: grey;" id="player-info">
    Current Page: <span id="currentNumber"></span> <span id="currentTime" style="padding-left: 1em;"></span> <span
        id="currentSpeed" style="padding-left: 1em;"></span>
</div>

<div id="message" style="display: none"></div>

<script>
  function toSeconds(str) {
    str = str + ""
    let splits = str.split(":")
    let hour = 0, mins = 0, secs = 0
    if (splits.length === 2) {
      mins = splits[0]
      secs = splits[1]
    }
    if (splits.length === 3) {
      hour = splits[0]
      mins = splits[1]
      secs = splits[2]
    }
    return parseInt(hour) * 3600 + parseInt(mins) * 60 + parseInt(secs)
  }

  function fromSeconds(number) {
    let _pad = x => x.length < 2 ? '0' + x : x;
    let hrs = Math.floor(number / 3600) + ''
    let mins = Math.floor((number % 3600) / 60) + ''
    let secs = Math.floor((number % 3600) % 60) + ''


    return `${_pad(hrs)}:${_pad(mins)}:${_pad(secs)}`
  }

  let URL = window.URL || window.webkitURL
  let displayMessage = function (message, isError) {
    let element = document.querySelector('#message')
    element.innerHTML = message
    element.className = isError ? 'error' : 'info'
  }

  let player = new MediaElement(document.querySelector('audio'), {
    defaultSpeed: 1.0,
    features: ['speed'],
    success: function (mediaElement, originalNode) {
      console.log('Media element', mediaElement, originalNode)
    }
  });

  window.player = player
  window.marginStartSubtitle = -0.1
  window.marginEndSubtitle = 1

  const isIOS = () => {
    const iosQuirkPresent = function () {
      const audio = new Audio();

      audio.volume = 0.5;
      return audio.volume === 1;   // volume cannot be changed from "1" on iOS 12 and below
    };

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAppleDevice = navigator.userAgent.includes('Macintosh');
    const isTouchScreen = navigator.maxTouchPoints >= 1;   // true for iOS 13 (and hopefully beyond)

    return isIOS || (isAppleDevice && (isTouchScreen || iosQuirkPresent()));
  };

  if (isIOS()) {
    window.marginStartSubtitle = -1
    window.marginEndSubtitle = 0
  }

  window.marginStartSubtitle = 0
  window.marginEndSubtitle = 0

  function pauseVideo() {
    window.player.pause()
    $('#playBtn').html('Play')
  }

  let currentVideoTime = () => {
    return parseFloat(parseFloat(player.getCurrentTime() + '').toFixed(2))
  }
  let clearSubtitles = () => {
    $('#sv-sub').html('')
    $('#en-sub').html('')
  }

  let renderSubtitles = (currentSub) => {

    if (window.renderedSub === currentSub.number) {
      return
    }

    console.log("Rendering subtitle for ", currentSub)

    window.renderedSub = currentSub.number

    $('#currentNumber').html(currentSub.number)
    $('#currentTime').html(fromSeconds(currentVideoTime()) + ' / [' + currentSub.ts_o + '-' + currentSub.te_o + ']')
    $('#currentSpeed').html(player.getPlaybackRate() + ' / ' + currentSub.speed)

    $('#sv-sub').html('')
    currentSub.sv.replaceAll("\n", " ").split(" ").map(it => it.trim()).filter(it => it.length > 0).forEach(word => {
      let sanitizedWord = word
      if (['-', '–', '!', '.', ','].some(it => sanitizedWord.startsWith(it))) {
        sanitizedWord = sanitizedWord.substr(1)
      }

      if (['-', '–', '!', '?', '.', ','].some(it => sanitizedWord.endsWith(it))) {
        sanitizedWord = sanitizedWord.substr(0, sanitizedWord.length - 1)
      }

      let wordLink = $(`<span> <a href="https://sv.wiktionary.org/wiki/${encodeURIComponent(sanitizedWord)}" target="_blank">${word}</a></span>`);
      wordLink.click(e => {
        pauseVideo()
      })
      $('#sv-sub').append(wordLink)
    })

    $('#en-sub').html(currentSub.en)
  }

  async function seekToYoutubeTime(t) {
    console.log("Seek request, target=", fromSeconds(t), "currentTime=", fromSeconds(window.ytPlayer.getCurrentTime()))
    window.ytPlayer.seekTo(t)
    window.seekRequestProcessing = true
    let leeway = Math.max(6, Math.abs(window.ytPlayer.getDuration() - t))

    return new Promise((resolve, reject) => {
      let interval = null
      interval = setInterval(() => {
        if (Math.abs(window.ytPlayer.getCurrentTime() - t) < leeway) {
          clearInterval(interval)
          console.log("Seek request completed", t, "currentTime=", window.ytPlayer.getCurrentTime())
          window.seekRequestProcessing = false
          resolve()
        } else {
          window.ytPlayer.seekTo(t)
        }
      }, 10)
    })
  }

  let prepareSubsForPage = async (pageNumber, setTime) => {
    pageNumber = parseInt(pageNumber)

    pageNumber = window.pageDataSource[pageNumber - 1]
    let allSubs = window.subtitles

    //Reset
    let subs = [allSubs.find(it => it.id + "" === pageNumber + "")].flatMap(sub => [
      // {...sub, speed: 0.6}
      // , {...sub, speed: 0.8}
      {...sub, speed: 1.0}
    ])

    let currentSub = subs.shift()
    console.log("Preparing subs for page", pageNumber, currentSub)

    if (setTime) {
      let newTime = Math.max(currentSub.ts + window.marginStartSubtitle, 0);
      if (window.playingVideo) {
        await seekToYoutubeTime(newTime)
      } else {
        player.setCurrentTime(newTime)
      }
    }

    // if(!window.rewindData)
    // player.setPlaybackRate(currentSub.speed)

    // player.play()

    window.subs = subs
    window.currentSub = currentSub
    window.pageNumber = pageNumber

    // $('#playBtn').html('Pause')
  }

  let $mp3Choice = $('#mp3Choice');

  function fixSectionBox() {
    $mp3Choice.select2();

    let optgroupState = {};

    $("body").on('click', '.select2-container--open .select2-results__group', function () {
      $(this).siblings().toggle();
      let id = $(this).closest('.select2-results__options').attr('id');
      let index = $('.select2-results__group').index(this);
      optgroupState[id][index] = !optgroupState[id][index];
    })

    $mp3Choice.on('select2:open', function () {
      $('.select2-dropdown--below').css('opacity', 0);
      setTimeout(() => {
        let groups = $('.select2-container--open .select2-results__group');
        let id = $('.select2-results__options').attr('id');
        if (!optgroupState[id]) {
          optgroupState[id] = {};
        }
        $.each(groups, (index, v) => {
          optgroupState[id][index] = optgroupState[id][index] || false;
          optgroupState[id][index] ? $(v).siblings().show() : $(v).siblings().hide();
        })
        $('.select2-dropdown--below').css('opacity', 1);
      }, 0);
    })
  }

  $(document).ready(function () {
    fixSectionBox()
  });

  async function fetchCategorisation() {
    let categorisation = await fetch("https://raw.githubusercontent.com/trexsatya/trexsatya.github.io/gh-pages/db/srts/categorisation.txt")
    categorisation = await categorisation.text()
    categorisation = categorisation.split("\n")
    let categories = {}
    categorisation.forEach(it => {
      let l = it.split(" || ")
      let c = '        '
      if (l.length === 4) {
        c = l[0]
      }
      categories[l[l.length - 1]] = c
    })
    return categories
  }

  function populateAllLinks() {
    let $mp3Choice = $('#mp3Choice');
    $mp3Choice.html('').append($(`<option>-</option>`).attr('value', ''))
    let srts = window.srts
    let srtLinks = Array.from(new Set(window.srts.map(it => it.link)));

    let categories = window.categories
    srtLinks = _(srtLinks).chain()
      .sortBy(link => getCategory({link}))
      // .sortBy(function(link) {
      //     let srt = srts.find(it => it.link === link)
      //     return srt.name.split(" || ")[0];
      // })
      .reverse()
      .value()

    let ogs = {}
    let getOptgroup = category => {
      if (!ogs[category]) {
        let label = category
        let filter = it => it === category

        if(category === 'Okategoriserad') {
          filter = it => it.trim().length === 0
        }

        let cnt = Object.values(window.categories).filter(filter).length
        label += " (" + cnt + ")"
        ogs[category] = $(`<optgroup label="${label}">`)
      }
      return ogs[category]
    }
    srtLinks.forEach(link => {
      let item = srts.find(it => it.link === link)
      let $opt = $(`<option>${item.name.replace(".en.srt", "").replace(".sv.srt", "")}</option>`).attr('value', item.link)
      getOptgroup(getCategory(item)).append($opt)
    })

    Object.values(ogs).forEach(it => $mp3Choice.append(it))
    return srts;
  }

  async function loadAllSubtitles() {
    let srts = await fetch("https://raw.githubusercontent.com/trexsatya/trexsatya.github.io/gh-pages/db/srts/index.json")
    srts = await srts.json()
    window.srts = srts

    srts.forEach(it => getSubtitlesForLink(it['link']))

    window.categories = await fetchCategorisation()

    populateAllLinks();
  }

  loadAllSubtitles()

  function srtToJson(text, lang) {
    let items = []
    let currentItem = {}
    currentItem[lang] = ''
    text.split("\n").forEach(line => {
      line = line.trim()
      let matchTime = line.match(/(\d\d:\d\d:\d\d,\d\d\d) --> (\d\d:\d\d:\d\d,\d\d\d)/m)
      let matchId = line.match(/^\d+$/m)
      if (matchId) {
        items.push(currentItem)
        currentItem = {id: line}
        currentItem[lang] = ''
      } else if (matchTime) {
        currentItem['ts'] = matchTime[1]
        currentItem['te'] = matchTime[2]
      } else {
        currentItem[lang] += (line + "\n")
      }
    })

    items.push(currentItem)
    return items.filter(it => it.ts)
  }

  function getCategory(item) {
    let link = item.link;
    let category = window.categories[link];
    category = category && category.trim()
    return category || 'Okategoriserad';
  }

  function searchText() {
    let searchText = $("#searchInput").val().trim()

    if (searchText.length < 3) {
      populateAllLinks()
      return
    }

    function getSrtObject(it) {
      return window.srts.find(srt => srt.link === it);
    }

    let items = Object.keys(window.allSubtitles).map(it => {
      let s = window.allSubtitles[it]
      let svMatch = s.sv.toLowerCase().indexOf(searchText) >= 0
      let enMatch = s.en.toLowerCase().indexOf(searchText) >= 0
      return {link: it, svMatch, enMatch}
    })
      .map(it => {
        let srt = getSrtObject(it.link)
        return {...it, ...srt}
      }).filter(it => it.svMatch || it.enMatch)

    let $mp3Choice = $('#mp3Choice')
    $mp3Choice.html('<option>--</option>')

    let ogs = {}
    let getOptgroup = category => {
      if (!ogs[category]) {
        ogs[category] = $(`<optgroup label="${category}">`)
      }
      return ogs[category]
    }

    items.map(item => {
      let subs = window.allSubtitles[item.link]
      let text = ''
      if(item.svMatch) {
        text = subs['sv']
      } else {
        text = subs['en']
      }

      let count = (text.toLowerCase().match(new RegExp(searchText, "gi")) || []).length;
      return ({...item, matches: count})
    }).toSorted((x, y) => y.matches - x.matches)
      .forEach(item => {
        let $opt = $(`<option>(${item.matches}) ${item.name.replace(".en.srt", "").replace(".sv.srt", "")}</option>`).attr('value', item.link)
        getOptgroup(getCategory(item)).append($opt)
      })

    Object.values(ogs).forEach(it => $mp3Choice.append(it))
  }

  function storeSubtitles(subs) {
    let strategy = "Normal-Slow"

    let originalSubs = subs.map(it => ({...it}))

    originalSubs.forEach(it => {
      it['ts_o'] = it['ts']
      it['ts'] = toSeconds(it['ts'])
    })

    originalSubs = _.sortBy(originalSubs, it => it.ts)

    for (let i = 0; i < originalSubs.length - 1; i++) {
      originalSubs[i]['te_o'] = originalSubs[i + 1]['ts_o']
      originalSubs[i]['te'] = originalSubs[i + 1]['ts'] - 0.009
      originalSubs[i]['number'] = i + 1
    }
    window.subtitles = originalSubs
    return originalSubs;
  }

  window.allSubtitles = {}
  window.srts = []

  async function getSubtitlesForLink(link) {
    if (window.allSubtitles[link]) {
      return window.allSubtitles[link]
    }
    let svName = window.srts.find(it => it.link === link).name + ".sv.srt"
    let enName = window.srts.find(it => it.link === link).name + ".en.srt"
    let sv = await fetch("https://raw.githubusercontent.com/trexsatya/trexsatya.github.io/gh-pages/db/srts/" + svName)
    sv = await sv.text()
    let en = await fetch("https://raw.githubusercontent.com/trexsatya/trexsatya.github.io/gh-pages/db/srts/" + enName)
    en = await en.text()

    window.allSubtitles[link] = {sv, en}
    return window.allSubtitles[link]
  }

  async function loadSubtitlesForLink(link) {
    let {sv, en} = await getSubtitlesForLink(link)

    if (!sv) {
      alert("SV subtitle not found")
      return
    }

    if (!en) {
      en = {...sv}
    }

    window.srtLoaded = sv
    sv = srtToJson(sv, 'sv')

    en = srtToJson(en, 'en')
    let combined = sv.map(svItem => {
      let enItem = en.find(eni => eni.ts === svItem.ts)
      let combinedItem = {...svItem, ...enItem};
      combinedItem['id'] = svItem.id //Give priority to SV subtitle
      return combinedItem
    })
    // console.log(sv)
    // console.log(en)
    console.log(combined)

    storeSubtitles(combined)

    player.setSrc(link)

    let pages = null
    let searchText = $("#searchInput").val().trim().toLowerCase();
    if (searchText.length > 0) {
      pages = sv.filter(it => it.sv.toLowerCase().indexOf(searchText) >= 0).map(it => it.id)
    }

    playSelectedFile(pages)
  }

  $mp3Choice.change(async e => {
    clearSubtitles()
    player.pause()
    stopVideo()
    //Load subtitle
    let link = $mp3Choice.val()
    let youtubeVideoId = link
    if (youtubeVideoId.trim().length) {
      $('#player').show()
      loadVideo(youtubeVideoId)
      window.playingVideo = true;
      $('#youtube-link').hide()
      loadSubtitlesForLink(link);
    } else {
      $('#player').hide()
      window.playingVideo = false;
      loadSubtitlesForLink(link);
    }
  })

  function setSpeed() {
    let newRate = $('.controlgroup input:checked').data('speed');
    if (playingVideo) {
      ytPlayer.setPlaybackRate(newRate)
    } else {
      player.setPlaybackRate(newRate)
    }
  }

  function goToCurrentPageNumber() {
    // console.log('Go to current page', new Date())
    let pageNum = $('#pagination').pagination('getCurrentPageNum')
    window.rewindData = null
    prepareSubsForPage(pageNum, true)
  }

  let playSelectedFile = function (pages) {
    let $pagination = $('#pagination');
    try {
      $pagination.pagination('destroy');
    } catch (e) {
      console.log(e)
    }

    let pageDataSource = pages || range(1, window.subtitles.length + 1);
    window.pageDataSource = pageDataSource
    $pagination.pagination({
      dataSource: pageDataSource,
      pageSize: 1,
      // showPrevious: false,
      // showNext: false,
      showGoInput: true,
      showGoButton: true,
      formatGoInput: 'go to <%= input %> st/rd/th',
      callback: function (data, pagination) {
        // console.log("Page changed", data)
      }, //page changed
      afterPageOnClick: e => {
        // console.log(e)
        goToCurrentPageNumber();
      },
      afterNextOnClick: e => {
        goToCurrentPageNumber();
      },
      afterPreviousOnClick: e => {
        goToCurrentPageNumber();
      }
    })

    $('#playBtn').attr('disabled', false)
    prepareSubsForPage(1, true)
    goToCurrentPageNumber()
    // console.log(originalSubs.map(it => `${it.number} ${it.ts_o}-${it.te_o} (${it.ts}-${it.te} )-> ${it.sv}`).join("\n"))
  }

  function updatePlayPauseButton() {
    if (ytPlayer.getPlayerState() === 2) {
      $('#playBtn').html('Play')
    } else if (ytPlayer.getPlayerState() === 1) {
      $('#playBtn').html('Pause')
    }
  }

  const ontimeupdate = e => {
    // console.log(currentSub, player.currentTime)
    if (window.seekRequestProcessing) {
      return
    }

    updatePlayPauseButton()

    let ct = player.getCurrentTime()
    if (window.playingVideo) {
      ct = window.ytPlayer.getCurrentTime()
    }

    if (window.rewindData) {
      if (ct >= window.rewindData.from) {
        window.rewindData = null
        console.log("Resetting speed", ct)
        player.setPlaybackRate(window.currentSub.speed)
      } else {
        // return
      }
    }

    renderSubtitles(window.currentSub)
    setSpeed();

    if (!window.rewindData && ct >= window.currentSub.te) {
      // Go to next subtitle
      // player.pause()
      $('#pagination').pagination('next', data => {
        console.log('Ontimeupdate: Going to next page', new Date(), "Current Time ", ct, "Data", data)
        prepareSubsForPage(window.pageDataSource.findIndex(it => it + "" === data + "") + 1, true)
      })
    }
  }

  function updatePlayBtn() {
    let el = $('#playBtn')[0]

    if (player.paused) {
      $(el).html("Play").removeClass('pause-btn').addClass('play-btn')
    } else {
      $(el).html("Pause").removeClass('play-btn').addClass('pause-btn')
    }
  }

  player.addEventListener('timeupdate', ontimeupdate)
  player.addEventListener('pause', updatePlayBtn)
  player.addEventListener('ended', updatePlayBtn)
  player.addEventListener('playing', updatePlayBtn)

  player.addEventListener('ended', e => {
    $('#pagination').pagination('go', 1)
    goToCurrentPageNumber()
    if ($('#loopSwitch').is(":checked")) {
      console.log('Replaying')
      sleep(2).then(() => $('#playBtn').click())
    }
  })

  let inputNode = document.querySelector('#video-file')
  if (inputNode)
    inputNode.addEventListener('change', playSelectedFile, false)

  function rewind() {
    window.rewindData = window.rewindData || {
      from: window.playingVideo ? ytPlayer.getCurrentTime() : player.getCurrentTime(),
    }

    console.log("Should come back to", window.rewindData.from)
    player.setPlaybackRate($('.controlgroup input:checked').data('speed'))

    if (window.playingVideo) {
      ytPlayer.seekTo(ytPlayer.getCurrentTime() - 3)
    } else {
      player.setCurrentTime(player.currentTime - 3)
    }
  }

  $('.controlgroup').controlgroup()

  document.onkeyup = e => {
    if (e.which === 32) { //Space
      togglePlay()
    }
  }
</script>

<script>
  // 2. This code loads the IFrame Player API code asynchronously.
  var tag = document.createElement('script');

  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // 3. This function creates an <iframe> (and YouTube player)
  //    after the API code downloads.

  function loadVideo(videoId) {
    let iframe = ytPlayer.getIframe()
    try {
      let currentVideoId = iframe.src.split("embed/")[1].split("?")[0]
      iframe.src = `${iframe.src}`.replaceAll(currentVideoId, videoId)
    } catch (e) {
      console.log(e)
    }
  }

  let wh = $(window).height(), ww = $(window).width();

  let ytVideoWidth = 940, ytHeight = 590;
  let subWidth = 0;

  if (ww >= 1000) {
    ytVideoWidth = ww * 0.6;
    subWidth = $(window).width() - (ytVideoWidth + 40)
  } else {
    ytVideoWidth = ww - 10;
    subWidth = ww - 10;
    ytHeight = wh / 2 - 50;
    $('#controls').css({width: '100%', bottom: '-15em', right: 0})
    $('#player-info').hide()
    $('#speed-control').parent().hide()

    $('#mp3Choice').parent().css({width: ww - 20})
  }

  function onYouTubeIframeAPIReady() {
    window.ytPlayer = new YT.Player('player', {
      height: ytHeight,
      width: ytVideoWidth,
      videoId: 'K8P_USOppfs',
      playerVars: {
        'playsinline': 1
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
    $('#subtitle-container').css({
      left: ytVideoWidth,
      marginLeft: '1em',
      width: subWidth
    })
  }

  // 4. The API will call this function when the video player is ready.
  function onPlayerReady(event) {
    event.target.playVideo();
  }


  function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING) {
      window.ytPlaying = true
    } else {
      window.ytPlaying = false;
    }
  }

  function stopVideo() {
    window.ytPlayer.stopVideo();
  }

  setInterval(() => {
    //Check time
    if (window.playingVideo && window.ytPlayer) {
      ontimeupdate()
    }
  }, 100)
</script>
</body>

</html>
